<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Anagramas ‚Äì juego con puntuaci√≥n</title>
<style>
  :root{
    --bg:#0f141b; --panel:#121a23; --muted:#9fb3c9; --tile:#0e1520;
    --grid:rgba(230,238,247,.12); --accent:#6ab0ff;
    --ok:#2ecc71; --warn:#ffb74d; --bad:#ff6b6b; --neutral:#90a4b6;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef7;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  h1{font-size:20px;margin:0 0 10px}
  .section{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:14px;margin-top:14px}
  .btn{background:var(--tile);border:1px solid var(--grid);color:#e6eef7;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
  .btn:hover{border-color:var(--accent)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}

  .letter-group{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;font-family:monospace;font-size:22px;margin:4px 0}
  .vocal{color:#6ab0ff}
  .cons{color:#ffb74d}
  .letters-block{display:flex;flex-direction:column;align-items:center;margin-top:8px}

  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;font-size:13px}
  .chip{background:var(--tile);border:1px solid var(--grid);padding:6px 10px;border-radius:999px}
  .ok{color:#bff4d2;border-color:rgba(46,204,113,.3);background:rgba(46,204,113,.12)}
  .warn{color:#ffd9a6;border-color:rgba(255,183,77,.35);background:rgba(255,183,77,.12)}
  .bad{color:#ffc7c7;border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12)}
  .progress{height:10px;background:#0b1118;border:1px solid var(--grid);border-radius:999px;overflow:hidden;margin-top:10px}
  .bar{height:100%;background:var(--accent);width:0%}

  /* Overlay del editor */
  .editor-wrap{position:relative}
  .highlight, .editor{
    font:16px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    white-space:pre-wrap; word-break:break-word;
    padding:12px; border-radius:10px; border:1px solid var(--grid);
    background:var(--tile); min-height:110px;
  }
  .highlight{color:transparent; pointer-events:none}
  .editor{position:absolute;inset:0;background:transparent;color:transparent;caret-color:#e6eef7;outline:none;resize:vertical;}
  .hl-ok{color:#9be7b0}
  .hl-warn{color:#ffd79a}
  .hl-bad{color:#ff9a9a}
  .hl-neutral{color:#7f93a6}

  /* Guardados */
  .saved-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .saved-item{display:flex;align-items:center;justify-content:space-between;gap:8px;background:var(--tile);border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
  .saved-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .iconbtn{background:transparent;border:1px solid var(--grid);color:#e6eef7;border-radius:8px;padding:6px 8px;cursor:pointer}
  .iconbtn:hover{border-color:var(--accent)}
  textarea.small{min-height:70px}

  /* Marcadores */
  .scoreboard{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--grid);background:var(--tile);padding:6px 10px;border-radius:999px}
  .big{font-size:18px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Anagramas ‚Äì juego con puntuaci√≥n</h1>

  <!-- NOMBRE BASE -->
  <div class="section">
    <textarea id="base" rows="2" placeholder="Escribe aqu√≠ tu nombre o frase base..." style="width:100%;color:#e6eef7;background:var(--tile);border:1px solid var(--grid);border-radius:10px;padding:12px;font-size:15px;"></textarea>
    <div class="letters-block">
      <div id="vocales" class="letter-group"></div>
      <div id="consonantes" class="letter-group"></div>
    </div>
  </div>

  <!-- CONTROLES DE JUEGO -->
  <div class="section">
    <div class="scoreboard">
      <span class="pill">‚è± <span id="timeLeft">60</span>s</span>
      <span class="pill big">‚≠ê Puntos: <span id="score">0</span></span>
      <span class="pill">üìè Letras usadas: <span id="lettersUsed">0</span></span>
      <button class="btn" id="startBtn">Jugar 60s</button>
      <button class="btn" id="resetBtn">Reiniciar</button>
    </div>
  </div>

  <!-- EDITOR Y GUARDAR -->
  <div class="section">
    <div class="editor-wrap">
      <div id="highlight" class="highlight"></div>
      <textarea id="editor" class="editor" placeholder="Escribe tu frase o anagrama candidato..."></textarea>
    </div>
    <div class="row">
      <button class="btn" id="saveBtn">Guardar</button>
    </div>
    <div class="progress"><div id="bar" class="bar"></div></div>
    <div class="chips" id="status"></div>
  </div>

  <!-- FRASES GUARDADAS -->
  <div class="section">
    <strong>Frases guardadas</strong>
    <div id="saved" class="saved-list"></div>
  </div>

  <!-- COMPOSICI√ìN -->
  <div class="section">
    <strong>Composici√≥n</strong>
    <textarea id="composer" class="highlight small" style="position:static;color:#e6eef7;background:var(--tile)" placeholder="Aqu√≠ puedes combinar frases guardadas‚Ä¶"></textarea>
    <div class="row">
      <button class="btn" id="toEditor">Pasar al editor</button>
      <button class="btn" id="copyComp">Copiar</button>
      <button class="btn" id="clearComp">Limpiar</button>
    </div>
  </div>
</div>

<script>
/* ======= Config ======= */
const ROUND_SECONDS = 60;       // duraci√≥n de la ronda
const TIER_BLOCK = 3;           // cada 3 letras sube el valor
const BONUS_PERFECT = 25;       // bonus por anagrama perfecto en una sola frase

/* ======= Utilidades ======= */
const vowels = new Set(['a','e','i','o','u']);
const esc = s => s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const baseEl = document.getElementById('base');
const vocalesEl = document.getElementById('vocales');
const consonantesEl = document.getElementById('consonantes');
const editor = document.getElementById('editor');
const highlight = document.getElementById('highlight');
const bar = document.getElementById('bar');
const status = document.getElementById('status');
const savedEl = document.getElementById('saved');
const composer = document.getElementById('composer');
const timeLeftEl = document.getElementById('timeLeft');
const scoreEl = document.getElementById('score');
const lettersUsedEl = document.getElementById('lettersUsed');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');

let playing = false;
let timer = null;

function normalize(str){return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/√±/g,'n');}
function lettersOnly(str){return normalize(str).replace(/[^a-z]/g,'');}
function countMap(str){const m={};for(const ch of lettersOnly(str))m[ch]=(m[ch]||0)+1;return m;}

/* Letras restantes (vocales arriba / consonantes abajo) */
function renderGroups(baseCounts,phraseCounts){
  const remaining={};
  for(const [ch,need] of Object.entries(baseCounts)){
    const used=Math.min(need,phraseCounts[ch]||0);
    remaining[ch]=Math.max(0,need-used);
  }
  const voc=[],cons=[];
  for(const [ch,count] of Object.entries(remaining)){
    for(let i=0;i<count;i++)(vowels.has(ch)?voc:cons).push(ch);
  }
  voc.sort(); cons.sort();
  vocalesEl.innerHTML=voc.map(l=>`<span class="vocal">${l.toUpperCase()}</span>`).join('');
  consonantesEl.innerHTML=cons.map(l=>`<span class="cons">${l.toUpperCase()}</span>`).join('');
}

/* Puntuaci√≥n de la frase actual (tier por posici√≥n de letra v√°lida/no v√°lida) */
function computeScoreAndMarkup(){
  const baseCounts = countMap(baseEl.value);
  const txt = editor.value;
  const usedPerLetter = {};        // consumo por letra para determinar "de m√°s"
  let lettersSeen = 0;             // solo letras A-Z vistas (para calcular tier)
  let score = 0;

  let out = '';

  for(const raw of txt){
    const n = normalize(raw);
    const isLetter = /^[a-z]$/.test(n);
    if(!isLetter){ out += `<span class="hl-neutral">${esc(raw)}</span>`; continue; }

    const tier = Math.floor(lettersSeen / TIER_BLOCK) + 1; // 1..‚àû
    lettersSeen++;

    const need = baseCounts[n] || 0;
    const have = usedPerLetter[n] || 0;

    if(need === 0){
      // no existe en base ‚Üí penaliza
      score -= tier;
      out += `<span class="hl-bad">${esc(raw)}</span>`;
    }else if(have < need){
      // dentro del cupo
      usedPerLetter[n] = have + 1;
      score += tier;
      out += `<span class="hl-ok">${esc(raw)}</span>`;
    }else{
      // repetida de m√°s
      score -= tier;
      out += `<span class="hl-warn">${esc(raw)}</span>`;
    }
  }

  // estado/bonus
  const phraseCounts = countMap(txt);
  const totalBase = Object.values(baseCounts).reduce((a,b)=>a+b,0);
  const missing=[], over=[], notIn=[];
  let usedCount = 0;

  for(const [ch,need] of Object.entries(baseCounts)){
    const have = phraseCounts[ch]||0;
    usedCount += Math.min(need, have);
    if(have < need) missing.push(`${ch.toUpperCase()}√ó${need-have}`);
  }
  for(const [ch,have] of Object.entries(phraseCounts)){
    const need = baseCounts[ch]||0;
    if(need===0) notIn.push(`${ch.toUpperCase()}√ó${have}`);
    else if(have>need) over.push(`${ch.toUpperCase()}√ó${have-need}`);
  }

  const perfect = !missing.length && !over.length && !notIn.length && lettersOnly(txt).length===totalBase;
  if(perfect && lettersOnly(txt).length>0) score += BONUS_PERFECT;

  // UI
  highlight.innerHTML = out;
  const pct = totalBase ? Math.round(usedCount/totalBase*100) : 0;
  bar.style.width = pct+'%';
  status.innerHTML='';
  if(missing.length) status.innerHTML += `<span class="chip warn">Faltan ${missing.join(', ')}</span>`;
  if(over.length) status.innerHTML += `<span class="chip bad">De m√°s ${over.join(', ')}</span>`;
  if(notIn.length) status.innerHTML += `<span class="chip bad">No permitidas ${notIn.join(', ')}</span>`;
  if(perfect) status.innerHTML = `<span class="chip ok">¬°Anagrama perfecto! (+${BONUS_PERFECT})</span>`;

  lettersUsedEl.textContent = lettersSeen;
  return score;
}

/* Recalcular todo */
function renderAll(){
  const baseCounts = countMap(baseEl.value);
  const phraseCounts = countMap(editor.value);
  renderGroups(baseCounts, phraseCounts);
  const score = computeScoreAndMarkup();
  if(playing) scoreEl.textContent = score; else scoreEl.textContent = score;
}

/* Guardados */
const STORAGE_KEY = 'anag_guardados_v1';
function loadSaved(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } }
function saveSaved(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
function renderSaved(){
  const arr = loadSaved();
  savedEl.innerHTML = '';
  if(arr.length===0){ savedEl.innerHTML = `<div style="opacity:.6">No hay frases guardadas.</div>`; return; }
  arr.forEach(item=>{
    const div=document.createElement('div'); div.className='saved-item';
    const txt=document.createElement('div'); txt.className='saved-text'; txt.textContent=item.text;
    const box=document.createElement('div'); box.className='row'; box.style.margin='0';
    const add=document.createElement('button'); add.className='iconbtn'; add.title='A√±adir a composici√≥n'; add.textContent='‚ûï';
    const edit=document.createElement('button'); edit.className='iconbtn'; edit.title='Editar en el editor'; edit.textContent='‚úé';
    const del=document.createElement('button'); del.className='iconbtn'; del.title='Borrar'; del.textContent='üóë';
    add.onclick=()=>{ composer.value = (composer.value ? composer.value + ' ' : '') + item.text; };
    edit.onclick=()=>{ editor.value=item.text; renderAll(); window.scrollTo({top:0,behavior:'smooth'}); };
    del.onclick=()=>{ const next = loadSaved().filter(x=>x.id!==item.id); saveSaved(next); renderSaved(); };
    box.append(add,edit,del);
    div.append(txt,box);
    savedEl.appendChild(div);
  });
}

/* Juego */
function startGame(){
  if(!lettersOnly(baseEl.value).length){ alert('Primero escribe el NOMBRE BASE.'); return; }
  playing = true;
  baseEl.disabled = true;
  editor.value = '';
  scoreEl.textContent = '0';
  lettersUsedEl.textContent = '0';
  timeLeftEl.textContent = ROUND_SECONDS;
  renderAll();
  editor.focus();

  let t = ROUND_SECONDS;
  timer = setInterval(()=>{
    t--; timeLeftEl.textContent = t;
    if(t<=0){ endGame(); }
  }, 1000);
}
function endGame(){
  playing = false;
  clearInterval(timer); timer = null;
  baseEl.disabled = false;
  // Deja el texto y la puntuaci√≥n visibles; puedes Guardar si quieres.
}
function resetGame(){
  playing = false;
  clearInterval(timer); timer = null;
  baseEl.disabled = false;
  editor.value = '';
  scoreEl.textContent = '0';
  lettersUsedEl.textContent = '0';
  timeLeftEl.textContent = ROUND_SECONDS;
  renderAll();
}

/* Eventos */
baseEl.addEventListener('input', renderAll);
editor.addEventListener('input', ()=>{ if(playing) renderAll(); else renderAll(); });
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const text = editor.value.trim(); if(!text) return;
  const arr = loadSaved(); arr.unshift({ id: Date.now(), text }); saveSaved(arr); renderSaved();
});
document.getElementById('toEditor').addEventListener('click', ()=>{ editor.value = composer.value; renderAll(); window.scrollTo({top:0,behavior:'smooth'}); });
document.getElementById('copyComp').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(composer.value); }catch(e){} });
document.getElementById('clearComp').addEventListener('click', ()=>{ composer.value=''; });

document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('resetBtn').addEventListener('click', resetGame);

/* Inicial */
renderSaved();
renderAll();
</script>
</body>
</html>
